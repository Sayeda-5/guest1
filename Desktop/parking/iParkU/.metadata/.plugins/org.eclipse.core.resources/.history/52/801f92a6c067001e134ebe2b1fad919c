package com.project.parking.Service;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.project.parking.Exception.PaymentException;
import com.project.parking.Model.Booking;
import com.project.parking.Model.BookingStatus;
import com.project.parking.Model.Payment;
import com.project.parking.Model.PaymentDTO;
import com.project.parking.Model.PaymentStatus;
import com.project.parking.Model.Session;
import com.project.parking.Repository.BookingDAO;
import com.project.parking.Repository.PaymentDAO;




@Service
public class PaymentServiceImpl implements PaymentService{

	@Autowired
	PaymentDAO paymentDAO;

	@Autowired
	BookingDAO bookingDao;

	

	@Override
	public Payment makePayment(PaymentDTO paymentDTO, Session session) throws PaymentException {

		Booking currentBooking = bookingDao.findById(paymentDTO.getBookingId()).orElseThrow(() -> new PaymentException(
				"Payment Cannot Be Done For Inavalid Booking ID : " + paymentDTO.getBookingId()));
		
		Payment newPayment = new Payment();

		
		if (currentBooking.getBookingStatus() == BookingStatus.PAYMENT_PENDING
				&& currentBooking.getCustomer().getCustomerId() == session.getUserId()) {

			newPayment.setBooking(currentBooking);
			newPayment.setPaymentStatus(PaymentStatus.SUCCESSFULL);
			newPayment.setPaymentInfo("Mode of Payment : UPI |" + "UPI ID : " + paymentDTO.getUpi_Id());
			newPayment.setPaymentAmount(currentBooking.getTotalCost());

			currentBooking.setBookingStatus(BookingStatus.BOOKING_CONFIRMED);
		
		} else {
			newPayment.setBooking(currentBooking);
			newPayment.setPaymentStatus(PaymentStatus.FAILED);

			if (currentBooking.getBookingStatus() == BookingStatus.BOOKING_CONFIRMED) {
				newPayment.setPaymentInfo("Payment for This Booking has Already been Done !!");
			} else {
				newPayment.setPaymentInfo("Payment Failed Due To Wrong/Invalid Credentials !!");
			}

			newPayment.setPaymentAmount(0.00);

			return newPayment;
		}
		return newPayment;

	}


	@Override
	public List<Payment> viewAllPayments() {
		// TODO Auto-generated method stub
		return null;
	}

}
